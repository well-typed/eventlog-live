# NixOS VM

This directory contains a NixOS configuration that builds a QEMU virtual machine corresponding to [the demo described in the README](https://github.com/well-typed/eventlog-live#demo), which sets up `eventlog-live-otelcol`, the `oddball` example program, the OpenTelemetry Collector, the Prometheus metric processor and database, the Tempo span processor and database, and Grafana.

## Building the VM

Building the VM requires a linux machine running [Nix](https://nixos.org) with flakes enabled.

Builds are tested on x86_64 and are not guaranteed to work with aarch64 or other architectures.

There are two flavours for the VM: _standalone_ and _lightweight_:

- The _standalone_ VM is intended for distribution.
  It is fully self-contained.
- The _lightweight_ VM is intended for development.
  It mounts the host machine's Nix store.
  Hence, it cannot be run on any other machine.
  However, it is significantly smaller and faster to build development.

To build a standalone image, run the following command from `nix/eventlog-live-otelcol`:

```
nix build .#standalone-vm
```

To build a lightweight image, run the following command from the `nix/eventlog-live-otelcol` directory:

```
nix build .#vm
```

To build standalone images for different architectures, you can use [remote builders](https://nixos.wiki/wiki/Distributed_build).
For instance, if you have set up a remote builder for `aarch64-linux` builds, then you can build a standalone image for `aarch64-linux` by running the following command from the `nix/eventlog-live-otelcol` directory:

```
nix build .#packages.aarch64-linux.standalone-vm
```

## Running the VM

There are two options for running the VM, depending on whether your system is capable of building the VM.

### Using Nix

If your system satisfies the build prerequisites, you can run the VM via Nix.
Run the following command from the `nix/eventlog-live-otelcol` directory:

```sh
./run-vm.sh
```

This will build a lightweight VM and run it using a wrapper generated by Nix.

### Using QEMU

You can always run the VM directly via [QEMU](https://www.qemu.org). This requires QEMU as well as a pre-built image, which you can either build following the instructions above, or download from [the CI artifacts](https://github.com/well-typed/eventlog-live/actions?query=branch%3Amaster+event%3Apush).

If you downloaded and unpacked the image from the CI artifacts, you can run the following command, where `result/nixos.qcow2` is the path to the image:

```sh
qemu-system-x86_64 \
    -m 4096 \
    -smp 4  \
    -drive file=result/nixos.qcow2,if=virtio \
    -nic user,hostfwd=tcp::2222-:22,hostfwd=tcp::3000-:3000,hostfwd=tcp::3200-:3200,hostfwd=tcp::9090-:9090,hostfwd=tcp::55679-:55679 \
    -nographic
```

If you built the image yourself, you may need to change the command. For instance, if you built an `aarch64` image, you should use `qemu-system-aarch64`.

## Using the VM

Once the VM is running, you should be able to access all the mentioned services. To view the heap profiling visualisation, navigate to Grafana at <http://localhost:3000>, log in using username `admin` and password `admin`, and open the heap profiling visualisation under â˜° > _Dashboards_ > _Browse_ then _General_ > _Eventlog Heap_.

The following services are exposed to the host system:

- Grafana <http://localhost:3000>
- Prometheus <http://localhost:9090>
- Tempo <http://localhost:3200>
- OpenTelemetry Collector zPages <http://localhost:55679>

You can SSH into the VM by running the following command and entering the password `nixos`:

```sh
ssh root@localhost -p 2222
```

## Troubleshooting

If any services fail to start, you can check the logs by running the following commands from within the VM:

```bash
# Check the service status (from within the VM)
systemctl status oddball
systemctl status eventlog-live-otelcol
systemctl status opentelemetry-collector

# Check the service logs (from within the VM)
journalctl -u oddball -f
journalctl -u eventlog-live-otelcol -f
```

## Customization

To use a different example program, modify the `configuration.nix` file:

1. Change the `oddball` package reference to point to your desired program.
2. Update the service configuration accordingly.
3. Adjust the environment variables as needed.
